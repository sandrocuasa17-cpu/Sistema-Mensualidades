{% extends "base.html" %}

{% block title %}Registrar Pago - Sistema de Mensualidades{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-credit-card-fill"></i> Registrar Pago</h2>
    <p>Registra un nuevo pago para {{ cliente.nombre_completo }}</p>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Info del Cliente -->
        <div class="card mb-4" style="border-left: 5px solid #667eea;">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-2">
                            <i class="bi bi-person-circle text-primary"></i> 
                            {{ cliente.nombre_completo }}
                        </h4>
                        <div class="mb-2">
                            <small class="text-muted"><i class="bi bi-envelope"></i> {{ cliente.email }}</small>
                        </div>
                        {% if cliente.telefono %}
                        <div class="mb-2">
                            <small class="text-muted"><i class="bi bi-phone"></i> {{ cliente.telefono }}</small>
                        </div>
                        {% endif %}
                        {% if cliente.curso %}
                        <div class="mt-2">
                            <span class="badge bg-info" style="font-size: 13px;">
                                <i class="bi bi-book"></i> {{ cliente.curso.nombre }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px; color: white;">
                            <small class="d-block mb-1" style="opacity: 0.9;">Saldo Pendiente</small>
                            <h2 class="mb-0 fw-bold">
                                ${{ "%.2f"|format(cliente.saldo_pendiente) }}
                            </h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ DESGLOSE DE DEUDAS MEJORADO -->
        {% if cliente.curso %}
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-calculator"></i> Estado de Cuenta
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Inscripci√≥n -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 {% if cliente.inscripcion_pagada %}border-success{% else %}border-warning{% endif %}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">
                                        <i class="bi bi-file-earmark-text"></i> Inscripci√≥n
                                    </h6>
                                    {% if cliente.inscripcion_pagada %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle-fill"></i> PAGADA
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock-fill"></i> PENDIENTE
                                        </span>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">Valor Total:</small>
                                    <h4 class="mb-0">${{ "%.2f"|format(cliente.curso.precio_inscripcion) }}</h4>
                                </div>
                                
                                {% if not cliente.inscripcion_pagada %}
                                    <div class="mb-2">
                                        <small class="text-muted">Abonado:</small>
                                        <div class="text-info fw-bold">${{ "%.2f"|format(cliente.abono_inscripcion or 0) }}</div>
                                    </div>
                                    <div>
                                        <small class="text-muted">Pendiente:</small>
                                        <div class="text-danger fw-bold">${{ "%.2f"|format(cliente.inscripcion_pendiente) }}</div>
                                    </div>
                                    
                                    <!-- Barra de progreso -->
                                    {% set progreso = (cliente.abono_inscripcion or 0) / cliente.curso.precio_inscripcion * 100 %}
                                    <div class="progress mt-2" style="height: 8px;">
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: {{ progreso }}%"
                                             aria-valuenow="{{ progreso }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.1f"|format(progreso) }}% completado</small>
                                {% else %}
                                    <div class="alert alert-success mb-0 py-2">
                                        <i class="bi bi-check-circle"></i> Inscripci√≥n completada
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mensualidad -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-info">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">
                                        <i class="bi bi-calendar-month"></i> Mensualidad
                                    </h6>
                                    <span class="badge bg-info">
                                        {{ cliente.mensualidades_canceladas }} pagadas
                                    </span>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">Valor Mensual:</small>
                                    <h4 class="mb-0">${{ "%.2f"|format(cliente.curso.precio_mensual) }}</h4>
                                </div>
                                
                                {% if cliente.fecha_fin %}
                                    <div class="mb-2">
                                        <small class="text-muted">Cobertura hasta:</small>
                                        <div class="fw-bold text-primary">
                                            {{ cliente.fecha_fin.strftime('%d/%m/%Y') }}
                                        </div>
                                    </div>
                                    <div>
                                        <small class="text-muted">D√≠as restantes:</small>
                                        <div class="fw-bold 
                                            {% if cliente.dias_restantes and cliente.dias_restantes > 7 %}text-success
                                            {% elif cliente.dias_restantes and cliente.dias_restantes > 0 %}text-warning
                                            {% else %}text-danger{% endif %}">
                                            {{ cliente.dias_restantes if cliente.dias_restantes and cliente.dias_restantes > 0 else 'VENCIDO' }}
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning mb-0 py-2">
                                        <i class="bi bi-exclamation-triangle"></i> Sin cobertura activa
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de Pago R√°pido MEJORADOS -->
                <div class="alert alert-light border mb-0">
                    <strong><i class="bi bi-lightning-charge-fill text-warning"></i> Pagos R√°pidos:</strong>
                    <div class="btn-group-vertical w-100 mt-2" role="group">
                        {% if not cliente.inscripcion_pagada %}
                            <button type="button" class="btn btn-outline-primary mb-2" 
                                    onclick="seleccionarConcepto('inscripcion', {{ cliente.inscripcion_pendiente }})">
                                <i class="bi bi-file-earmark-check"></i> Pagar Inscripci√≥n Completa 
                                <span class="badge bg-primary">${{ "%.2f"|format(cliente.inscripcion_pendiente) }}</span>
                            </button>
                        {% endif %}
                        
                        <button type="button" class="btn btn-outline-success mb-2" 
                                onclick="seleccionarConcepto('mensualidad', {{ cliente.curso.precio_mensual }})">
                            <i class="bi bi-calendar-check"></i> Pagar 1 Mensualidad
                            <span class="badge bg-success">${{ "%.2f"|format(cliente.curso.precio_mensual) }}</span>
                        </button>
                        
                        {% if not cliente.inscripcion_pagada %}
                            {% set total_completo = cliente.inscripcion_pendiente + cliente.curso.precio_mensual %}
                            <button type="button" class="btn btn-outline-warning" 
                                    onclick="seleccionarConcepto('completo', {{ total_completo }})">
                                <i class="bi bi-check-all"></i> Inscripci√≥n + 1 Mensualidad
                                <span class="badge bg-warning text-dark">${{ "%.2f"|format(total_completo) }}</span>
                            </button>
                        {% endif %}
                    </div>
                    
                    <div class="mt-3 p-2 bg-info bg-opacity-10 rounded">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Abonos parciales:</strong> Puedes pagar cualquier monto y se distribuir√° autom√°ticamente
                            (primero inscripci√≥n, luego mensualidades).
                        </small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Formulario de Pago -->
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                <h5 class="mb-0">
                    <i class="bi bi-cash-stack"></i> Registrar Pago
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="formPago">
                    <!-- Selector de Concepto -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-tag"></i> Concepto del Pago
                        </label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="concepto_pago" id="concepto_auto" value="auto" checked>
                            <label class="btn btn-outline-primary" for="concepto_auto">
                                <i class="bi bi-magic"></i> Autom√°tico
                            </label>
                            
                            <input type="radio" class="btn-check" name="concepto_pago" id="concepto_inscripcion" value="inscripcion">
                            <label class="btn btn-outline-info" for="concepto_inscripcion">
                                <i class="bi bi-file-earmark"></i> Inscripci√≥n
                            </label>
                            
                            <input type="radio" class="btn-check" name="concepto_pago" id="concepto_mensualidad" value="mensualidad">
                            <label class="btn btn-outline-success" for="concepto_mensualidad">
                                <i class="bi bi-calendar"></i> Mensualidad
                            </label>
                        </div>
                        <small class="text-muted">
                            <strong>Autom√°tico:</strong> Primero inscripci√≥n, luego mensualidades
                        </small>
                    </div>

                    <!-- Monto -->
                    <div class="mb-4">
                        <label for="monto" class="form-label fw-bold">
                            <i class="bi bi-currency-dollar"></i> Monto a Pagar *
                        </label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-success text-white">$</span>
                            <input type="number" 
                                   class="form-control form-control-lg" 
                                   id="monto" 
                                   name="monto" 
                                   step="0.01" 
                                   min="0.01"
                                   value=""
                                   required
                                   autofocus>
                        </div>
                        <div id="montoHelper" class="form-text"></div>
                    </div>

                    <div class="row">
                        <!-- M√©todo de Pago -->
                        <div class="col-md-6 mb-3">
                            <label for="metodo_pago" class="form-label fw-bold">
                                <i class="bi bi-credit-card"></i> M√©todo de Pago
                            </label>
                            <select class="form-select" id="metodo_pago" name="metodo_pago">
                                <option value="">Seleccionar...</option>
                                <option value="Efectivo">üíµ Efectivo</option>
                                <option value="Transferencia">üè¶ Transferencia Bancaria</option>
                                <option value="Tarjeta">üí≥ Tarjeta de Cr√©dito/D√©bito</option>
                                <option value="Dep√≥sito">üèß Dep√≥sito Bancario</option>
                                <option value="PayPal">üÖøÔ∏è PayPal</option>
                                <option value="Zelle">üí∏ Zelle</option>
                                <option value="Otro">üì± Otro</option>
                            </select>
                        </div>

                        <!-- Periodo -->
                        <div class="col-md-6 mb-3">
                            <label for="periodo" class="form-label fw-bold">
                                <i class="bi bi-calendar-month"></i> Periodo
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="periodo" 
                                   name="periodo" 
                                   placeholder="Ej: Enero 2025">
                            <small class="text-muted">Mes o periodo que cubre</small>
                        </div>
                    </div>

                    <!-- Referencia -->
                    <div class="mb-3">
                        <label for="referencia" class="form-label fw-bold">
                            <i class="bi bi-receipt"></i> Referencia/Comprobante
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="referencia" 
                               name="referencia" 
                               placeholder="N√∫mero de referencia o transacci√≥n">
                    </div>

                    <!-- Notas -->
                    <div class="mb-4">
                        <label for="notas" class="form-label fw-bold">
                            <i class="bi bi-chat-left-text"></i> Notas Adicionales
                        </label>
                        <textarea class="form-control" 
                                  id="notas" 
                                  name="notas" 
                                  rows="3"
                                  placeholder="Informaci√≥n adicional sobre este pago..."></textarea>
                    </div>

                    <!-- Vista Previa del Pago MEJORADA -->
                    <div class="card bg-light mb-4" id="vistaPrevia" style="display: none;">
                        <div class="card-body">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-eye-fill"></i> Vista Previa del Pago
                            </h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <small class="text-muted">Estudiante:</small>
                                    <div class="fw-bold">{{ cliente.nombre_completo }}</div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Monto Total:</small>
                                    <div class="text-success fs-4 fw-bold" id="previewMonto">$0.00</div>
                                </div>
                            </div>
                            
                            <!-- Desglose de distribuci√≥n -->
                            <div id="previewDesglose" class="border-top pt-3"></div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <small class="text-muted">M√©todo:</small>
                                    <div id="previewMetodo" class="fw-bold">No especificado</div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Periodo:</small>
                                    <div id="previewPeriodo" class="fw-bold">No especificado</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="row mt-4">
                        <div class="col-md-6 mb-2">
                            <a href="{{ url_for('cliente_detalle', id=cliente.id) }}" 
                               class="btn btn-secondary btn-lg w-100">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button type="submit" class="btn btn-success btn-lg w-100" id="btnSubmit">
                                <i class="bi bi-check-circle-fill"></i> Registrar Pago
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Historial Reciente -->
        {% if cliente.pagos %}
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i> √öltimos Pagos
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Monto</th>
                                <th>Concepto</th>
                                <th>M√©todo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pago in cliente.pagos[:5] %}
                            <tr>
                                <td>
                                    <small>{{ pago.fecha_pago.strftime('%d/%m/%Y') }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-success">${{ "%.2f"|format(pago.monto) }}</span>
                                </td>
                                <td>
                                    <small>{{ pago.concepto or 'Autom√°tico' }}</small>
                                </td>
                                <td>
                                    <small>{{ pago.metodo_pago or '-' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales del curso
const PRECIO_INSCRIPCION = {{ cliente.curso.precio_inscripcion if cliente.curso else 0 }};
const PRECIO_MENSUAL = {{ cliente.curso.precio_mensual if cliente.curso else 0 }};
const ABONO_INSCRIPCION = {{ cliente.abono_inscripcion or 0 }};
const INSCRIPCION_PENDIENTE = {{ cliente.inscripcion_pendiente if cliente.curso else 0 }};
const INSCRIPCION_PAGADA = {{ 'true' if cliente.inscripcion_pagada else 'false' }};

// Funci√≥n para seleccionar concepto y monto r√°pido
function seleccionarConcepto(tipo, monto) {
    const montoInput = document.getElementById('monto');
    montoInput.value = monto.toFixed(2);
    
    // Seleccionar radio button correspondiente
    if (tipo === 'inscripcion') {
        document.getElementById('concepto_inscripcion').checked = true;
    } else if (tipo === 'mensualidad') {
        document.getElementById('concepto_mensualidad').checked = true;
    } else {
        document.getElementById('concepto_auto').checked = true;
    }
    
    actualizarVistaPrevia();
    montoInput.focus();
}

document.addEventListener('DOMContentLoaded', function() {
    const formPago = document.getElementById('formPago');
    const montoInput = document.getElementById('monto');
    const metodoPagoSelect = document.getElementById('metodo_pago');
    const periodoInput = document.getElementById('periodo');
    const vistaPrevia = document.getElementById('vistaPrevia');
    const btnSubmit = document.getElementById('btnSubmit');
    const conceptoRadios = document.querySelectorAll('input[name="concepto_pago"]');
    
    // Auto-generar periodo actual
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const fecha = new Date();
    const periodoActual = `${meses[fecha.getMonth()]} ${fecha.getFullYear()}`;
    periodoInput.placeholder = `Ej: ${periodoActual}`;
    
    // Funci√≥n para calcular distribuci√≥n del pago
    function calcularDistribucion(monto, concepto) {
        const distribucion = {
            inscripcion: 0,
            mensualidades: 0,
            carry: 0,
            mensualidades_completas: 0
        };
        
        let saldo = parseFloat(monto) || 0;
        
        if (saldo <= 0) return distribucion;
        
        // Concepto autom√°tico
        if (concepto === 'auto') {
            // Primero inscripci√≥n
            if (!INSCRIPCION_PAGADA && INSCRIPCION_PENDIENTE > 0) {
                if (saldo >= INSCRIPCION_PENDIENTE) {
                    distribucion.inscripcion = INSCRIPCION_PENDIENTE;
                    saldo -= INSCRIPCION_PENDIENTE;
                } else {
                    distribucion.inscripcion = saldo;
                    saldo = 0;
                }
            }
            
            // Luego mensualidades
            if (saldo > 0 && PRECIO_MENSUAL > 0) {
                distribucion.mensualidades_completas = Math.floor(saldo / PRECIO_MENSUAL);
                distribucion.mensualidades = distribucion.mensualidades_completas * PRECIO_MENSUAL;
                distribucion.carry = saldo - distribucion.mensualidades;
            }
        }
        // Solo inscripci√≥n
        else if (concepto === 'inscripcion') {
            if (!INSCRIPCION_PAGADA && INSCRIPCION_PENDIENTE > 0) {
                distribucion.inscripcion = Math.min(saldo, INSCRIPCION_PENDIENTE);
            }
        }
        // Solo mensualidad
        else if (concepto === 'mensualidad') {
            if (PRECIO_MENSUAL > 0) {
                distribucion.mensualidades_completas = Math.floor(saldo / PRECIO_MENSUAL);
                distribucion.mensualidades = distribucion.mensualidades_completas * PRECIO_MENSUAL;
                distribucion.carry = saldo - distribucion.mensualidades;
            }
        }
        
        return distribucion;
    }
    
    // Funci√≥n para actualizar vista previa
    function actualizarVistaPrevia() {
        const monto = parseFloat(montoInput.value) || 0;
        const metodo = metodoPagoSelect.options[metodoPagoSelect.selectedIndex]?.text || 'No especificado';
        const periodo = periodoInput.value || 'No especificado';
        const concepto = document.querySelector('input[name="concepto_pago"]:checked')?.value || 'auto';
        
        if (monto > 0) {
            // Mostrar monto
            document.getElementById('previewMonto').textContent = '$' + monto.toFixed(2);
            document.getElementById('previewMetodo').textContent = metodo;
            document.getElementById('previewPeriodo').textContent = periodo;
            
            // Calcular distribuci√≥n
            const dist = calcularDistribucion(monto, concepto);
            
            // Generar desglose
            let desgloseHTML = '<div class="mb-2"><strong>Distribuci√≥n del pago:</strong></div>';
            
            if (dist.inscripcion > 0) {
                const completaInscripcion = (ABONO_INSCRIPCION + dist.inscripcion) >= PRECIO_INSCRIPCION;
                desgloseHTML += `
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <div>
                            <i class="bi bi-file-earmark-text text-primary"></i> 
                            <strong>Inscripci√≥n:</strong>
                            ${completaInscripcion ? '<span class="badge bg-success ms-2">‚úì COMPLETA</span>' : ''}
                        </div>
                        <span class="badge bg-primary">$${dist.inscripcion.toFixed(2)}</span>
                    </div>
                `;
            }
            
            if (dist.mensualidades_completas > 0) {
                desgloseHTML += `
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <div>
                            <i class="bi bi-calendar-check text-success"></i> 
                            <strong>Mensualidades:</strong>
                            <span class="badge bg-success ms-2">${dist.mensualidades_completas} mes${dist.mensualidades_completas > 1 ? 'es' : ''}</span>
                        </div>
                        <span class="badge bg-success">$${dist.mensualidades.toFixed(2)}</span>
                    </div>
                `;
            }
            
            if (dist.carry > 0) {
                const faltante = PRECIO_MENSUAL - dist.carry;
                desgloseHTML += `
                    <div class="alert alert-info mb-0 py-2">
                        <small>
                            <i class="bi bi-info-circle"></i> 
                            <strong>Cr√©dito acumulado:</strong> $${dist.carry.toFixed(2)}
                            <br>Faltan $${faltante.toFixed(2)} para completar otra mensualidad
                        </small>
                    </div>
                `;
            }
            
            if (dist.inscripcion === 0 && dist.mensualidades === 0 && dist.carry === 0) {
                desgloseHTML += `
                    <div class="alert alert-warning mb-0 py-2">
                        <small><i class="bi bi-exclamation-triangle"></i> Monto insuficiente o concepto no aplicable</small>
                    </div>
                `;
            }
            
            document.getElementById('previewDesglose').innerHTML = desgloseHTML;
            vistaPrevia.style.display = 'block';
            
            // Helper text para el input
            const helperText = document.getElementById('montoHelper');
            if (dist.inscripcion > 0 || dist.mensualidades > 0 || dist.carry > 0) {
                helperText.innerHTML = '<i class="bi bi-check-circle text-success"></i> Pago v√°lido';
                helperText.className = 'form-text text-success';
            } else {
                helperText.innerHTML = '<i class="bi bi-info-circle"></i> Ingresa el monto a pagar';
                helperText.className = 'form-text text-muted';
            }
        } else {
            vistaPrevia.style.display = 'none';
        }
    }
    
    // Hacer funci√≥n global
    window.actualizarVistaPrevia = actualizarVistaPrevia;
    
    // Event listeners
    montoInput.addEventListener('input', actualizarVistaPrevia);
    metodoPagoSelect.addEventListener('change', actualizarVistaPrevia);
    periodoInput.addEventListener('input', actualizarVistaPrevia);
    conceptoRadios.forEach(radio => {
        radio.addEventListener('change', actualizarVistaPrevia);
    });
    
    // Validaci√≥n al enviar
    formPago.addEventListener('submit', function(e) {
        const monto = parseFloat(montoInput.value);
        
        if (!monto || monto <= 0) {
            e.preventDefault();
            alert('‚ùå El monto debe ser mayor a 0');
            montoInput.focus();
            return false;
        }
        
        // Deshabilitar bot√≥n
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
    });
    
    // Inicializar
    actualizarVistaPrevia();
});
</script>
{% endblock %}