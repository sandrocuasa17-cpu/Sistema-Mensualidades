{% extends "base.html" %}

{% block title %}Configuración del Sistema{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-gear-fill"></i> Configuración del Sistema</h2>
    <p>Gestiona la configuración general, licencia y correos electrónicos</p>
</div>

<!-- Estado de Licencia -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i> Estado de Licencia
                </h5>
            </div>
            <div class="card-body">
                {% if info_licencia.es_demo %}
                    <!-- Modo DEMO -->
                    <div class="alert alert-warning d-flex align-items-center" style="border-left: 5px solid #ffc107;">
                        <i class="bi bi-clock-history" style="font-size: 64px; margin-right: 25px; opacity: 0.8;"></i>
                        <div>
                            <h4 class="mb-2">
                                <i class="bi bi-tools"></i> MODO DEMO ACTIVO
                            </h4>
                            <p class="mb-1" style="font-size: 16px;">{{ info_licencia.mensaje }}</p>
                            {% if info_licencia.info.minutos_restantes %}
                            <h5 class="mt-3 mb-0" style="color: #856404;">
                                <i class="bi bi-hourglass-split"></i> 
                                Tiempo restante: <strong>{{ info_licencia.info.minutos_restantes }} minutos</strong>
                            </h5>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <h6><strong><i class="bi bi-info-circle-fill"></i> Características del Modo DEMO:</strong></h6>
                                <div class="row mt-3">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <i class="bi bi-clock" style="font-size: 32px; color: #0dcaf0;"></i>
                                            <p class="mt-2 mb-0"><strong>Duración</strong></p>
                                            <p class="mb-0">30 minutos</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <i class="bi bi-check-circle" style="font-size: 32px; color: #198754;"></i>
                                            <p class="mt-2 mb-0"><strong>Funciones</strong></p>
                                            <p class="mb-0">Todas disponibles</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <i class="bi bi-laptop" style="font-size: 32px; color: #0d6efd;"></i>
                                            <p class="mt-2 mb-0"><strong>Vinculación</strong></p>
                                            <p class="mb-0">Solo este PC</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <i class="bi bi-exclamation-triangle" style="font-size: 32px; color: #dc3545;"></i>
                                            <p class="mt-2 mb-0"><strong>Al finalizar</strong></p>
                                            <p class="mb-0">Activar licencia</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- Licencia Activa -->
                    <div class="alert alert-success d-flex align-items-center" style="border-left: 5px solid #38ef7d;">
                        <i class="bi bi-check-circle-fill" style="font-size: 64px; margin-right: 25px; color: #38ef7d;"></i>
                        <div class="flex-grow-1">
                            <h4 class="mb-2">
                                <i class="bi bi-patch-check-fill"></i> LICENCIA ACTIVA
                            </h4>
                            <p class="mb-0" style="font-size: 16px;">{{ info_licencia.mensaje }}</p>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <div style="text-align: center;">
                                    <i class="bi bi-person-circle" style="font-size: 48px; opacity: 0.9;"></i>
                                    <h6 class="mt-3 mb-1" style="opacity: 0.9;">Cliente</h6>
                                    <h5 class="mb-0"><strong>{{ info_licencia.info.cliente_nombre }}</strong></h5>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                                <div style="text-align: center;">
                                    <i class="bi bi-envelope-fill" style="font-size: 48px; opacity: 0.9;"></i>
                                    <h6 class="mt-3 mb-1" style="opacity: 0.9;">Email</h6>
                                    <h6 class="mb-0" style="font-size: 13px; word-break: break-all;">
                                        <strong>{{ info_licencia.info.cliente_email }}</strong>
                                    </h6>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                <div style="text-align: center;">
                                    <i class="bi bi-calendar-event" style="font-size: 48px; opacity: 0.9;"></i>
                                    <h6 class="mt-3 mb-1" style="opacity: 0.9;">Vencimiento</h6>
                                    <h6 class="mb-0"><strong>{{ info_licencia.info.fecha_expiracion }}</strong></h6>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white;">
                                <div style="text-align: center;">
                                    <i class="bi bi-hourglass-split" style="font-size: 48px; opacity: 0.9;"></i>
                                    <h6 class="mt-3 mb-1" style="opacity: 0.9;">Días Restantes</h6>
                                    <h3 class="mb-0"><strong>{{ info_licencia.info.dias_restantes }}</strong></h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if info_licencia.datos_empresa %}
                    <div class="alert alert-info mt-4" style="border-left: 5px solid #0dcaf0;">
                        <h6><i class="bi bi-building"></i> <strong>Datos de Empresa Configurados:</strong></h6>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p class="mb-2"><i class="bi bi-building"></i> <strong>Razón Social:</strong> {{ info_licencia.datos_empresa.razon_social }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><i class="bi bi-card-list"></i> <strong>RUC:</strong> {{ info_licencia.datos_empresa.ruc }}</p>
                            </div>
                            {% if info_licencia.datos_empresa.direccion %}
                            <div class="col-md-6">
                                <p class="mb-2"><i class="bi bi-geo-alt"></i> <strong>Dirección:</strong> {{ info_licencia.datos_empresa.direccion }}</p>
                            </div>
                            {% endif %}
                            {% if info_licencia.datos_empresa.telefono %}
                            <div class="col-md-6">
                                <p class="mb-2"><i class="bi bi-telephone"></i> <strong>Teléfono:</strong> {{ info_licencia.datos_empresa.telefono }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Activación de Licencia (Solo si está en DEMO) -->
{% if info_licencia.es_demo %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card" style="border: 3px solid #ffc107;">
            <div class="card-header" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white;">
                <h5 class="card-title mb-0">
                    <i class="bi bi-key-fill"></i> Activar Licencia Completa
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('configuracion') }}">
                    <input type="hidden" name="accion" value="activar_licencia">
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Instrucciones de Activación:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Ingresa la <strong>Clave de Licencia</strong> (formato: POS-XXXX-XXXX-XXXX-XXXX)</li>
                            <li>Pega los <strong>Datos Codificados</strong> completos</li>
                            <li>Haz clic en "Activar Licencia"</li>
                        </ol>
                    </div>
                    
                    <div class="mb-3">
                        <label for="license_key" class="form-label">
                            <i class="bi bi-key"></i> Clave de Licencia *
                        </label>
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="license_key" 
                               name="license_key"
                               placeholder="POS-XXXX-XXXX-XXXX-XXXX"
                               required
                               style="text-transform: uppercase; font-family: 'Courier New', monospace;">
                        <small class="text-muted">Ejemplo: POS-A1B2-C3D4-E5F6-G7H8</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="license_data" class="form-label">
                            <i class="bi bi-file-code"></i> Datos Codificados *
                        </label>
                        <textarea class="form-control" 
                                  id="license_data" 
                                  name="license_data"
                                  rows="6"
                                  placeholder="Pega aquí la cadena de datos codificados completa..."
                                  required
                                  style="font-family: 'Courier New', monospace; font-size: 13px;"></textarea>
                        <small class="text-muted">Cadena larga de caracteres que recibiste con tu licencia</small>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>⚠️ Importante:</strong> La licencia se vinculará <strong>permanentemente</strong> a este computador. 
                        No podrá transferirse a otro equipo.
                    </div>
                    
                    <button type="submit" class="btn btn-warning btn-lg w-100" style="font-weight: 700;">
                        <i class="bi bi-shield-check"></i> Activar Licencia Ahora
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Configuración de Correo Electrónico -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="bi bi-envelope-at-fill"></i> Configuración de Correo Electrónico</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('configuracion') }}">
                    <input type="hidden" name="accion" value="guardar_correo">
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Usar Gmail:</strong> Necesitas crear una "Contraseña de aplicación":
                        <ol class="mb-0 mt-2">
                            <li>Ve a tu cuenta de Google → Seguridad</li>
                            <li>Activa la verificación en dos pasos</li>
                            <li>Ve a "Contraseñas de aplicaciones"</li>
                            <li>Genera una contraseña para "Correo"</li>
                            <li>Usa esa contraseña aquí abajo</li>
                        </ol>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="mail_server" class="form-label">Servidor SMTP *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="mail_server" 
                                   name="mail_server"
                                   value="{{ config_correo.mail_server }}"
                                   placeholder="smtp.gmail.com"
                                   required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="mail_port" class="form-label">Puerto *</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="mail_port" 
                                   name="mail_port"
                                   value="{{ config_correo.mail_port }}"
                                   placeholder="587"
                                   required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mail_username" class="form-label">
                            <i class="bi bi-person"></i> Usuario (Email) *
                        </label>
                        <input type="email" 
                               class="form-control" 
                               id="mail_username" 
                               name="mail_username"
                               value="{{ config_correo.mail_username }}"
                               placeholder="tu-correo@gmail.com"
                               required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mail_password" class="form-label">
                            <i class="bi bi-lock"></i> Contraseña de Aplicación *
                        </label>
                        <input type="password" 
                               class="form-control" 
                               id="mail_password" 
                               name="mail_password"
                               value="{{ config_correo.mail_password }}"
                               placeholder="xxxx xxxx xxxx xxxx"
                               required>
                        <small class="text-muted">Para Gmail: usa la contraseña de aplicación, no tu contraseña normal</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mail_sender" class="form-label">
                            <i class="bi bi-send"></i> Correo Remitente *
                        </label>
                        <input type="email" 
                               class="form-control" 
                               id="mail_sender" 
                               name="mail_sender"
                               value="{{ config_correo.mail_sender }}"
                               placeholder="noreply@tuempresa.com"
                               required>
                        <small class="text-muted">Este correo aparecerá como remitente en los emails</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-save"></i> Guardar Configuración
                            </button>
                        </div>
                        <div class="col-md-6">
                            <a href="{{ url_for('test_correo') }}" class="btn btn-info btn-lg w-100">
                                <i class="bi bi-envelope-check"></i> Probar Correo
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Recordatorios Automáticos -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="bi bi-bell-fill"></i> Sistema de Recordatorios</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Recordatorios Automáticos:</strong> El sistema envía correos automáticamente 3 días antes de que termine una mensualidad y 1 dia despues de que se haya terminado.
                </div>
                
                <div class="row text-center">
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('enviar_recordatorios') }}" 
                           class="btn btn-lg btn-primary w-100"
                           onclick="return confirm('¿Enviar recordatorios ahora a todos los clientes morosos y con planes vencidos?')">
                            <i class="bi bi-bell d-block mb-2" style="font-size: 32px;"></i>
                            <strong>Enviar Recordatorios Ahora</strong>
                            <br><small>A clientes morosos y vencidos</small>
                        </a>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('index') }}" class="btn btn-lg btn-secondary w-100">
                            <i class="bi bi-house d-block mb-2" style="font-size: 32px;"></i>
                            <strong>Volver al Dashboard</strong>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Validar formato de clave de licencia
    const licenseKeyInput = document.getElementById('license_key');
    if (licenseKeyInput) {
        licenseKeyInput.addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase();
            value = value.replace(/[^A-Z0-9-]/g, '');
            e.target.value = value;
        });
    }
    
    // Auto-actualizar si está en DEMO
    {% if info_licencia.es_demo and info_licencia.info.minutos_restantes %}
    setTimeout(function() {
        location.reload();
    }, 60000); // Recargar cada minuto
    {% endif %}
</script>
{% endblock %}