{% extends "base.html" %}

{% block title %}Configuraci√≥n del Sistema{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-gear-fill"></i> Configuraci√≥n del Sistema</h2>
    <p>Gestiona la configuraci√≥n general, licencia y correos electr√≥nicos</p>
</div>

<!-- Estado de Licencia -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i> Estado de Licencia
                </h5>
            </div>
            <div class="card-body">
                {% if info_licencia.es_demo %}
                    <!-- Modo DEMO -->
                    <div class="alert alert-warning d-flex align-items-center" style="border-left: 5px solid #ffc107;">
                        <i class="bi bi-clock-history" style="font-size: 64px; margin-right: 25px; opacity: 0.8;"></i>
                        <div>
                            <h4 class="mb-2">
                                <i class="bi bi-tools"></i> MODO DEMO ACTIVO
                            </h4>
                            <p class="mb-1" style="font-size: 16px;">{{ info_licencia.mensaje }}</p>
                            {% if info_licencia.info.minutos_restantes %}
                            <h5 class="mt-3 mb-0" style="color: #856404;">
                                <i class="bi bi-hourglass-split"></i> 
                                Tiempo restante: <strong>{{ info_licencia.info.minutos_restantes }} minutos</strong>
                            </h5>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <h6><strong><i class="bi bi-info-circle-fill"></i> Caracter√≠sticas del Modo DEMO:</strong></h6>
                                <div class="row mt-3">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <i class="bi bi-clock" style="font-size: 32px; color: #0dcaf0;"></i>
                                            <p class="mt-2 mb-0"><strong>Duraci√≥n</strong></p>
                                            <p class="mb-0">30 minutos</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <i class="bi bi-check-circle" style="font-size: 32px; color: #198754;"></i>
                                            <p class="mt-2 mb-0"><strong>Funciones</strong></p>
                                            <p class="mb-0">Todas disponibles</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <i class="bi bi-laptop" style="font-size: 32px; color: #0d6efd;"></i>
                                            <p class="mt-2 mb-0"><strong>Vinculaci√≥n</strong></p>
                                            <p class="mb-0">Solo este PC</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <i class="bi bi-exclamation-triangle" style="font-size: 32px; color: #dc3545;"></i>
                                            <p class="mt-2 mb-0"><strong>Al finalizar</strong></p>
                                            <p class="mb-0">Activar licencia</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- Licencia Activa -->
                    <div class="alert alert-success d-flex align-items-center" style="border-left: 5px solid #38ef7d;">
                        <i class="bi bi-check-circle-fill" style="font-size: 64px; margin-right: 25px; color: #38ef7d;"></i>
                        <div class="flex-grow-1">
                            <h4 class="mb-2">
                                <i class="bi bi-patch-check-fill"></i> LICENCIA ACTIVA
                            </h4>
                            <p class="mb-0" style="font-size: 16px;">{{ info_licencia.mensaje }}</p>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <div style="text-align: center;">
                                    <i class="bi bi-person-circle" style="font-size: 48px; opacity: 0.9;"></i>
                                    <h6 class="mt-3 mb-1" style="opacity: 0.9;">Cliente</h6>
                                    <h5 class="mb-0"><strong>{{ info_licencia.info.cliente_nombre }}</strong></h5>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                                <div style="text-align: center;">
                                    <i class="bi bi-envelope-fill" style="font-size: 48px; opacity: 0.9;"></i>
                                    <h6 class="mt-3 mb-1" style="opacity: 0.9;">Email</h6>
                                    <h6 class="mb-0" style="font-size: 13px; word-break: break-all;">
                                        <strong>{{ info_licencia.info.cliente_email }}</strong>
                                    </h6>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                <div style="text-align: center;">
                                    <i class="bi bi-calendar-event" style="font-size: 48px; opacity: 0.9;"></i>
                                    <h6 class="mt-3 mb-1" style="opacity: 0.9;">Vencimiento</h6>
                                    <h6 class="mb-0"><strong>{{ info_licencia.info.fecha_expiracion }}</strong></h6>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white;">
                                <div style="text-align: center;">
                                    <i class="bi bi-hourglass-split" style="font-size: 48px; opacity: 0.9;"></i>
                                    <h6 class="mt-3 mb-1" style="opacity: 0.9;">D√≠as Restantes</h6>
                                    <h3 class="mb-0"><strong>{{ info_licencia.info.dias_restantes }}</strong></h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if info_licencia.datos_empresa %}
                    <div class="alert alert-info mt-4" style="border-left: 5px solid #0dcaf0;">
                        <h6><i class="bi bi-building"></i> <strong>Datos de Empresa Configurados:</strong></h6>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p class="mb-2"><i class="bi bi-building"></i> <strong>Raz√≥n Social:</strong> {{ info_licencia.datos_empresa.razon_social }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><i class="bi bi-card-list"></i> <strong>RUC:</strong> {{ info_licencia.datos_empresa.ruc }}</p>
                            </div>
                            {% if info_licencia.datos_empresa.direccion %}
                            <div class="col-md-6">
                                <p class="mb-2"><i class="bi bi-geo-alt"></i> <strong>Direcci√≥n:</strong> {{ info_licencia.datos_empresa.direccion }}</p>
                            </div>
                            {% endif %}
                            {% if info_licencia.datos_empresa.telefono %}
                            <div class="col-md-6">
                                <p class="mb-2"><i class="bi bi-telephone"></i> <strong>Tel√©fono:</strong> {{ info_licencia.datos_empresa.telefono }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Activaci√≥n de Licencia (Solo si est√° en DEMO) -->
{% if info_licencia.es_demo %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card" style="border: 3px solid #ffc107;">
            <div class="card-header" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white;">
                <h5 class="card-title mb-0">
                    <i class="bi bi-key-fill"></i> Activar Licencia Completa
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('configuracion') }}">
                    <input type="hidden" name="accion" value="activar_licencia">
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Instrucciones de Activaci√≥n:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Ingresa la <strong>Clave de Licencia</strong> (formato: POS-XXXX-XXXX-XXXX-XXXX)</li>
                            <li>Pega los <strong>Datos Codificados</strong> completos</li>
                            <li>Haz clic en "Activar Licencia"</li>
                        </ol>
                    </div>
                    
                    <div class="mb-3">
                        <label for="license_key" class="form-label">
                            <i class="bi bi-key"></i> Clave de Licencia *
                        </label>
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="license_key" 
                               name="license_key"
                               placeholder="POS-XXXX-XXXX-XXXX-XXXX"
                               required
                               style="text-transform: uppercase; font-family: 'Courier New', monospace;">
                        <small class="text-muted">Ejemplo: POS-A1B2-C3D4-E5F6-G7H8</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="license_data" class="form-label">
                            <i class="bi bi-file-code"></i> Datos Codificados *
                        </label>
                        <textarea class="form-control" 
                                  id="license_data" 
                                  name="license_data"
                                  rows="6"
                                  placeholder="Pega aqu√≠ la cadena de datos codificados completa..."
                                  required
                                  style="font-family: 'Courier New', monospace; font-size: 13px;"></textarea>
                        <small class="text-muted">Cadena larga de caracteres que recibiste con tu licencia</small>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>‚ö†Ô∏è Importante:</strong> La licencia se vincular√° <strong>permanentemente</strong> a este computador. 
                        No podr√° transferirse a otro equipo.
                    </div>
                    
                    <button type="submit" class="btn btn-warning btn-lg w-100" style="font-weight: 700;">
                        <i class="bi bi-shield-check"></i> Activar Licencia Ahora
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Sistema de Backup de Base de Datos -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-database-fill-gear"></i> Backup de Base de Datos
                </h5>
            </div>
            <div class="card-body">
                <!-- Informaci√≥n importante -->
                <div class="alert alert-warning">
                    <h6 class="alert-heading">
                        <i class="bi bi-exclamation-triangle-fill"></i> 
                        <strong>MUY IMPORTANTE:</strong>
                    </h6>
                    <ol class="mb-0">
                        <li><strong>Antes de actualizar:</strong> Descarga tu base de datos como respaldo</li>
                        <li><strong>Si algo sale mal:</strong> Sube el archivo descargado para restaurar tus datos</li>
                        <li><strong>Guarda el archivo .db:</strong> En un lugar seguro (Google Drive, Dropbox, etc.)</li>
                    </ol>
                </div>
                
                <!-- Informaci√≥n de la BD actual -->
                <div class="card mb-3" style="background: #f8f9fa;">
                    <div class="card-body">
                        <h6 class="mb-3">
                            <i class="bi bi-info-circle"></i> Base de Datos Actual:
                        </h6>
                        <div id="db-info-loading" class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <span class="ms-2">Cargando informaci√≥n...</span>
                        </div>
                        <div id="db-info-content" style="display: none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <p class="mb-2">
                                        <i class="bi bi-file-earmark-text"></i> 
                                        <strong>Archivo:</strong> 
                                        <span id="db-nombre" class="text-primary"></span>
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-2">
                                        <i class="bi bi-hdd"></i> 
                                        <strong>Tama√±o:</strong> 
                                        <span id="db-tamano" class="text-success"></span>
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-2">
                                        <i class="bi bi-calendar-check"></i> 
                                        <strong>√öltima modificaci√≥n:</strong> 
                                        <span id="db-fecha"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Acciones de backup -->
                <div class="row">
                    <!-- Descargar BD -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-success">
                            <div class="card-body text-center">
                                <i class="bi bi-download" style="font-size: 48px; color: #198754;"></i>
                                <h5 class="mt-3 mb-3">Descargar Base de Datos</h5>
                                <p class="text-muted mb-3">
                                    Descarga tu base de datos actual como respaldo antes de cualquier actualizaci√≥n
                                </p>
                                <a href="{{ url_for('descargar_bd') }}" 
                                   class="btn btn-success btn-lg w-100">
                                    <i class="bi bi-cloud-download"></i> 
                                    Descargar Ahora (.db)
                                </a>
                                <small class="d-block mt-2 text-muted">
                                    El archivo se descargar√° con fecha y hora actual
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Subir/Restaurar BD -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-warning">
                            <div class="card-body text-center">
                                <i class="bi bi-upload" style="font-size: 48px; color: #ffc107;"></i>
                                <h5 class="mt-3 mb-3">Restaurar Base de Datos</h5>
                                <p class="text-muted mb-3">
                                    Sube un archivo .db previamente descargado para restaurar tus datos
                                </p>
                                
                                <form method="POST" 
                                      action="{{ url_for('subir_bd') }}" 
                                      enctype="multipart/form-data"
                                      id="form-restaurar"
                                      onsubmit="return confirmarRestauracion(event)">
                                    <div class="mb-3">
                                        <input type="file" 
                                               class="form-control" 
                                               id="archivo_bd" 
                                               name="archivo_bd"
                                               accept=".db"
                                               required>
                                    </div>
                                    <button type="submit" class="btn btn-warning btn-lg w-100" id="btn-restaurar">
                                        <i class="bi bi-cloud-upload"></i> 
                                        Restaurar Base de Datos
                                    </button>
                                </form>
                                
                                <small class="d-block mt-2 text-danger">
                                    ‚ö†Ô∏è Esto sobrescribir√° la base de datos actual
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Instrucciones detalladas -->
                <div class="accordion mt-4" id="instruccionesBackup">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapseInstrucciones">
                                <i class="bi bi-question-circle me-2"></i>
                                <strong>¬øC√≥mo usar el sistema de backup?</strong>
                            </button>
                        </h2>
                        <div id="collapseInstrucciones" class="accordion-collapse collapse" 
                             data-bs-parent="#instruccionesBackup">
                            <div class="accordion-body">
                                <h6><strong>üì• Antes de actualizar:</strong></h6>
                                <ol>
                                    <li>Haz clic en "Descargar Ahora"</li>
                                    <li>Guarda el archivo .db en un lugar seguro (tu computadora, Google Drive, etc.)</li>
                                    <li>Anota la fecha y hora del backup</li>
                                    <li>Procede con tu actualizaci√≥n</li>
                                </ol>
                                
                                <h6 class="mt-4"><strong>üì§ Si necesitas restaurar:</strong></h6>
                                <ol>
                                    <li>Haz clic en "Examinar" y selecciona tu archivo .db</li>
                                    <li>Confirma la restauraci√≥n</li>
                                    <li>El sistema crear√° un backup de seguridad autom√°tico antes de restaurar</li>
                                    <li>La aplicaci√≥n se recargar√° con los datos restaurados</li>
                                </ol>
                                
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="bi bi-lightbulb"></i> 
                                    <strong>Consejo:</strong> Descarga un backup antes de cada deploy. 
                                    Los archivos .db son peque√±os y f√°ciles de guardar.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuraci√≥n de Correo Electr√≥nico -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="bi bi-envelope-at-fill"></i> Configuraci√≥n de Correo Electr√≥nico</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('configuracion') }}">
                    <input type="hidden" name="accion" value="guardar_correo">
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Usar Gmail:</strong> Necesitas crear una "Contrase√±a de aplicaci√≥n":
                        <ol class="mb-0 mt-2">
                            <li>Ve a tu cuenta de Google ‚Üí Seguridad</li>
                            <li>Activa la verificaci√≥n en dos pasos</li>
                            <li>Ve a "Contrase√±as de aplicaciones"</li>
                            <li>Genera una contrase√±a para "Correo"</li>
                            <li>Usa esa contrase√±a aqu√≠ abajo</li>
                        </ol>
                    </div>
                    
                    <!-- Reemplaza la secci√≥n de PERSONALIZACI√ìN en configuracion.html -->

<!-- ‚úÖ PERSONALIZACI√ìN DE CORREOS (CORREGIDO) -->
<div class="alert alert-primary mb-4">
    <h6 class="alert-heading">
        <i class="bi bi-palette-fill"></i> 
        <strong>Personalizaci√≥n de Correos</strong>
    </h6>
    <p class="mb-3">Configura c√≥mo aparecer√° tu empresa en los correos enviados a los estudiantes</p>
    
    <div class="row">
        <!-- ‚úÖ NOMBRE DE EMPRESA -->
        <div class="col-md-6 mb-3">
            <label for="nombre_empresa" class="form-label">
                <i class="bi bi-building"></i> <strong>Nombre de la Empresa/Instituci√≥n *</strong>
            </label>
            <input type="text" 
                   class="form-control form-control-lg" 
                   id="nombre_empresa" 
                   name="nombre_empresa"
                   value="{{ config_correo.nombre_empresa }}"
                   placeholder="Ej: Preuniversitario XYZ, Academia ABC"
                   maxlength="100"
                   required>
            <small class="text-muted">Este nombre aparecer√° en todos los correos enviados</small>
        </div>

        <!-- ‚úÖ ESLOGAN (OPCIONAL) -->
        <div class="col-md-6 mb-3">
            <label for="eslogan_empresa" class="form-label">
                <i class="bi bi-star"></i> <strong>Eslogan/Subt√≠tulo</strong> (Opcional)
            </label>
            <input type="text" 
                   class="form-control" 
                   id="eslogan_empresa" 
                   name="eslogan_empresa"
                   value="{{ config_correo.eslogan_empresa }}"
                   placeholder="Ej: Excelencia Acad√©mica, Tu Futuro Comienza Aqu√≠"
                   maxlength="150">
            <small class="text-muted">Opcional: Aparecer√° debajo del nombre en los correos</small>
        </div>
    </div>

    <!-- ‚úÖ VISTA PREVIA -->
    <div class="mt-3 p-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
            <h4 class="mb-2" id="preview-nombre" style="font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                {{ config_correo.nombre_empresa if config_correo.nombre_empresa else 'Sistema de Gesti√≥n de Mensualidades' }}
            </h4>
            <p class="mb-0" id="preview-eslogan" style="opacity: 0.95; font-size: 15px;">
                {{ config_correo.eslogan_empresa if config_correo.eslogan_empresa else 'Ingresa un eslogan para verlo aqu√≠' }}
            </p>
        </div>
        <small class="d-block mt-3" style="opacity: 0.8;">
            <i class="bi bi-eye"></i> Vista previa de c√≥mo aparecer√° en los correos
        </small>
    </div>
</div>


                    
                    <!-- Configuraci√≥n SMTP -->
                    <h6 class="mb-3"><i class="bi bi-gear"></i> Configuraci√≥n del Servidor SMTP</h6>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="mail_server" class="form-label">Servidor SMTP *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="mail_server" 
                                   name="mail_server"
                                   value="{{ config_correo.mail_server }}"
                                   placeholder="smtp.gmail.com"
                                   required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="mail_port" class="form-label">Puerto *</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="mail_port" 
                                   name="mail_port"
                                   value="{{ config_correo.mail_port }}"
                                   placeholder="587"
                                   required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mail_username" class="form-label">
                            <i class="bi bi-person"></i> Usuario (Email) *
                        </label>
                        <input type="email" 
                               class="form-control" 
                               id="mail_username" 
                               name="mail_username"
                               value="{{ config_correo.mail_username }}"
                               placeholder="tu-correo@gmail.com"
                               required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mail_password" class="form-label">
                            <i class="bi bi-lock"></i> Contrase√±a de Aplicaci√≥n *
                        </label>
                        <input type="password" 
                               class="form-control" 
                               id="mail_password" 
                               name="mail_password"
                               value="{{ config_correo.mail_password }}"
                               placeholder="xxxx xxxx xxxx xxxx"
                               required>
                        <small class="text-muted">Para Gmail: usa la contrase√±a de aplicaci√≥n, no tu contrase√±a normal</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mail_sender" class="form-label">
                            <i class="bi bi-send"></i> Correo Remitente *
                        </label>
                        <input type="email" 
                               class="form-control" 
                               id="mail_sender" 
                               name="mail_sender"
                               value="{{ config_correo.mail_sender }}"
                               placeholder="noreply@tuempresa.com"
                               required>
                        <small class="text-muted">Este correo aparecer√° como remitente en los emails</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-save"></i> Guardar Configuraci√≥n
                            </button>
                        </div>
                        <div class="col-md-6">
                            <a href="{{ url_for('test_correo') }}" class="btn btn-info btn-lg w-100">
                                <i class="bi bi-envelope-check"></i> Probar Correo
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Recordatorios Autom√°ticos -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="bi bi-bell-fill"></i> Sistema de Recordatorios</h5>
            </div>

            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Recordatorios Autom√°ticos:</strong> El sistema env√≠a correos autom√°ticamente 3 d√≠as antes de que termine una mensualidad y 1 dia despues de que se haya terminado.
                </div>
                
                <div class="row text-center">
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('enviar_recordatorios') }}" 
                           class="btn btn-lg btn-primary w-100"
                           onclick="return confirm('¬øEnviar recordatorios ahora a todos los clientes morosos y con planes vencidos?')">
                            <i class="bi bi-bell d-block mb-2" style="font-size: 32px;"></i>
                            <strong>Enviar Recordatorios Ahora</strong>
                            <br><small>A clientes morosos y vencidos</small>
                        </a>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('index') }}" class="btn btn-lg btn-secondary w-100">
                            <i class="bi bi-house d-block mb-2" style="font-size: 32px;"></i>
                            <strong>Volver al Dashboard</strong>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√≥n Cambiar Contrase√±a -->
<div class="row mb-4">
    <div class="col-md-12">
        <a href="{{ url_for('cambiar_password_route') }}" class="btn btn-warning btn-lg w-100">
            <i class="bi bi-key"></i> Cambiar Contrase√±a
        </a>
    </div>
</div>

<!-- Sistema de Testing (SOLO DESARROLLO) -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bug-fill"></i> üß™ Herramientas de Testing
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger">
                    <h6 class="alert-heading">
                        <i class="bi bi-exclamation-triangle-fill"></i> 
                        <strong>‚ö†Ô∏è SOLO PARA PRUEBAS:</strong>
                    </h6>
                    <p class="mb-0">
                        Estas herramientas modifican datos reales. √ösalas con cuidado y solo en ambiente de desarrollo.
                    </p>
                </div>
                
                <!-- Seleccionar estudiante para testing -->
                <div class="mb-4">
                    <label class="form-label">
                        <strong><i class="bi bi-person"></i> Seleccionar Estudiante:</strong>
                    </label>
                    <select class="form-select" id="estudiante-testing">
                        <option value="">-- Selecciona un estudiante --</option>
                    </select>
                </div>
                
                <!-- Botones de Testing -->
                <div class="row">
                    <!-- Test: Registrar Pago -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-primary">
                            <div class="card-body text-center">
                                <i class="bi bi-cash-coin" style="font-size: 48px; color: #0d6efd;"></i>
                                <h6 class="mt-3 mb-3">Test: Registro de Pago</h6>
                                <p class="text-muted small">
                                    Simula un pago de 1 mensualidad y env√≠a correo de confirmaci√≥n
                                </p>
                                <button class="btn btn-primary w-100" onclick="testPago()">
                                    <i class="bi bi-play-fill"></i> Probar Pago
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test: Pr√≥ximo a Vencer -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-warning">
                            <div class="card-body text-center">
                                <i class="bi bi-exclamation-triangle" style="font-size: 48px; color: #ffc107;"></i>
                                <h6 class="mt-3 mb-3">Test: Pr√≥ximo a Vencer</h6>
                                <p class="text-muted small">
                                    Ajusta fecha_fin a 3 d√≠as y env√≠a recordatorio
                                </p>
                                <button class="btn btn-warning w-100" onclick="testProximoVencer()">
                                    <i class="bi bi-play-fill"></i> Probar Aviso
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test: Vencido -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-danger">
                            <div class="card-body text-center">
                                <i class="bi bi-x-circle" style="font-size: 48px; color: #dc3545;"></i>
                                <h6 class="mt-3 mb-3">Test: Vencido</h6>
                                <p class="text-muted small">
                                    Ajusta fecha_fin a -10 d√≠as y env√≠a recordatorio
                                </p>
                                <button class="btn btn-danger w-100" onclick="testVencido()">
                                    <i class="bi bi-play-fill"></i> Probar Vencido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bot√≥n de Restaurar Estado -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <button class="btn btn-secondary btn-lg w-100" onclick="restaurarEstado()">
                            <i class="bi bi-arrow-counterclockwise"></i> 
                            Restaurar Estado Original del Estudiante
                        </button>
                    </div>
                </div>
                
                <!-- Log de acciones -->
                <div class="mt-4">
                    <h6><strong>üìã Log de Pruebas:</strong></h6>
                    <div id="testing-log" class="p-3 bg-light border rounded" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px;">
                        <p class="text-muted mb-0">Selecciona un estudiante y ejecuta una prueba...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Validar formato de clave de licencia
    const licenseKeyInput = document.getElementById('license_key');
    if (licenseKeyInput) {
        licenseKeyInput.addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase();
            value = value.replace(/[^A-Z0-9-]/g, '');
            e.target.value = value;
        });
    }
    
    // Auto-actualizar si est√° en DEMO
    {% if info_licencia.es_demo and info_licencia.info.minutos_restantes %}
    setTimeout(function() {
        location.reload();
    }, 60000);
    {% endif %}
    
    // ====================================
    // SISTEMA DE BACKUP
    // ====================================
    
    function cargarInfoBD() {
        fetch('{{ url_for("backup_info") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('db-nombre').textContent = data.info.nombre;
                    document.getElementById('db-tamano').textContent = data.info.tamano_mb + ' MB';
                    document.getElementById('db-fecha').textContent = data.info.fecha_modificacion;
                    
                    document.getElementById('db-info-loading').style.display = 'none';
                    document.getElementById('db-info-content').style.display = 'block';
                } else {
                    document.getElementById('db-info-loading').innerHTML = 
                        '<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Error cargando informaci√≥n</span>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('db-info-loading').innerHTML = 
                    '<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Error de conexi√≥n</span>';
            });
    }
    
    function confirmarRestauracion(event) {
        const archivo = document.getElementById('archivo_bd').files[0];
        
        if (!archivo) {
            alert('‚ùå Por favor selecciona un archivo');
            return false;
        }
        
        if (!archivo.name.endsWith('.db')) {
            alert('‚ùå El archivo debe tener extensi√≥n .db');
            return false;
        }
        
        const confirmacion = confirm(
            '‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\n' +
            '¬øEst√°s seguro de restaurar la base de datos?\n\n' +
            '‚Ä¢ Se sobrescribir√° la base de datos actual\n' +
            '‚Ä¢ Se crear√° un backup de seguridad autom√°tico\n' +
            '‚Ä¢ La aplicaci√≥n se recargar√°\n\n' +
            'Archivo seleccionado: ' + archivo.name + '\n' +
            'Tama√±o: ' + (archivo.size / (1024 * 1024)).toFixed(2) + ' MB'
        );
        
        if (confirmacion) {
            const btnSubmit = document.getElementById('btn-restaurar');
            btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Restaurando...';
            btnSubmit.disabled = true;
        }
        
        return confirmacion;
    }
    
    // ====================================
    // SISTEMA DE TESTING
    // ====================================
    
    async function cargarEstudiantes() {
        try {
            const response = await fetch('/api/estudiantes-activos');
            const data = await response.json();
            
            const select = document.getElementById('estudiante-testing');
            select.innerHTML = '<option value="">-- Selecciona un estudiante --</option>';
            
            data.estudiantes.forEach(est => {
                const option = document.createElement('option');
                option.value = est.id;
                option.textContent = `${est.nombre_completo} - ${est.email}`;
                select.appendChild(option);
            });
        } catch (error) {
            log('‚ùå Error cargando estudiantes: ' + error, 'danger');
        }
    }
    
    function log(mensaje, tipo = 'info') {
        const logDiv = document.getElementById('testing-log');
        const timestamp = new Date().toLocaleTimeString();
        const badge = tipo === 'success' ? 'success' : tipo === 'danger' ? 'danger' : 'info';
        
        const entry = document.createElement('p');
        entry.className = `mb-1 text-${badge}`;
        entry.innerHTML = `<strong>[${timestamp}]</strong> ${mensaje}`;
        
        logDiv.insertBefore(entry, logDiv.firstChild);
    }
    
    function getEstudianteSeleccionado() {
        const select = document.getElementById('estudiante-testing');
        const estudianteId = select.value;
        
        if (!estudianteId) {
            alert('‚ö†Ô∏è Por favor selecciona un estudiante primero');
            return null;
        }
        
        return estudianteId;
    }
    
    async function testPago() {
        const estudianteId = getEstudianteSeleccionado();
        if (!estudianteId) return;
        
        if (!confirm('¬øSimular un pago de 1 mensualidad para este estudiante?')) return;
        
        try {
            log(`üîÑ Simulando pago para estudiante ${estudianteId}...`, 'info');
            
            const response = await fetch(`/test-pago-estudiante/${estudianteId}`);
            const data = await response.json();
            
            if (data.success) {
                log(`‚úÖ ${data.mensaje}`, 'success');
                if (data.correo_enviado) {
                    log(`üìß Correo enviado a: ${data.email}`, 'success');
                }
            } else {
                log(`‚ùå Error: ${data.error}`, 'danger');
            }
        } catch (error) {
            log(`‚ùå Error en test: ${error}`, 'danger');
        }
    }
    
    async function testProximoVencer() {
        const estudianteId = getEstudianteSeleccionado();
        if (!estudianteId) return;
        
        if (!confirm('¬øAjustar fecha de vencimiento a 3 d√≠as y enviar recordatorio?')) return;
        
        try {
            log(`üîÑ Configurando estudiante pr√≥ximo a vencer...`, 'info');
            
            const response = await fetch(`/test-proximo-vencer/${estudianteId}`);
            const data = await response.json();
            
            if (data.success) {
                log(`‚úÖ ${data.mensaje}`, 'success');
                log(`üìÖ Nueva fecha de vencimiento: ${data.fecha_fin}`, 'info');
                if (data.correo_enviado) {
                    log(`üìß Recordatorio enviado a: ${data.email}`, 'success');
                }
            } else {
                log(`‚ùå Error: ${data.error}`, 'danger');
            }
        } catch (error) {
            log(`‚ùå Error en test: ${error}`, 'danger');
        }
    }
    
    async function testVencido() {
        const estudianteId = getEstudianteSeleccionado();
        if (!estudianteId) return;
        
        if (!confirm('¬øAjustar fecha de vencimiento a -10 d√≠as (vencido) y enviar recordatorio?')) return;
        
        try {
            log(`üîÑ Configurando estudiante vencido...`, 'info');
            
            const response = await fetch(`/test-vencido/${estudianteId}`);
            const data = await response.json();
            
            if (data.success) {
                log(`‚úÖ ${data.mensaje}`, 'success');
                log(`üìÖ Nueva fecha de vencimiento: ${data.fecha_fin}`, 'info');
                if (data.correo_enviado) {
                    log(`üìß Recordatorio enviado a: ${data.email}`, 'success');
                }
            } else {
                log(`‚ùå Error: ${data.error}`, 'danger');
            }
        } catch (error) {
            log(`‚ùå Error en test: ${error}`, 'danger');
        }
    }
    
    async function restaurarEstado() {
        const estudianteId = getEstudianteSeleccionado();
        if (!estudianteId) return;
        
        if (!confirm('¬øRestaurar el estado original del estudiante?')) return;
        
        try {
            log(`üîÑ Restaurando estado original...`, 'info');
            
            const response = await fetch(`/test-restaurar/${estudianteId}`);
            const data = await response.json();
            
            if (data.success) {
                log(`‚úÖ ${data.mensaje}`, 'success');
            } else {
                log(`‚ùå Error: ${data.error}`, 'danger');
            }
        } catch (error) {
            log(`‚ùå Error restaurando: ${error}`, 'danger');
        }
    }
    
    // Cargar al iniciar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        cargarInfoBD();
        if (document.getElementById('estudiante-testing')) {
            cargarEstudiantes();
        }
    });


   
document.addEventListener('DOMContentLoaded', function() {
    const inputNombre = document.getElementById('nombre_empresa');
    const inputEslogan = document.getElementById('eslogan_empresa');
    const previewNombre = document.getElementById('preview-nombre');
    const previewEslogan = document.getElementById('preview-eslogan');
    
    // Actualizar nombre en tiempo real
    if (inputNombre && previewNombre) {
        inputNombre.addEventListener('input', function() {
            const valor = this.value.trim();
            previewNombre.textContent = valor || 'Sistema de Gesti√≥n de Mensualidades';
        });
    }
    
    // Actualizar eslogan en tiempo real
    if (inputEslogan && previewEslogan) {
        inputEslogan.addEventListener('input', function() {
            const valor = this.value.trim();
            previewEslogan.textContent = valor || 'Ingresa un eslogan para verlo aqu√≠';
            previewEslogan.style.opacity = valor ? '0.95' : '0.7';
        });
    }
});
</script>
{% endblock %}