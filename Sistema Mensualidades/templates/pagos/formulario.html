{% extends "base.html" %}

{% block title %}Registrar Pago - Sistema de Mensualidades{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="bi bi-credit-card-fill"></i> Registrar Pago</h2>
    <p>Registra un nuevo pago para {{ cliente.nombre_completo }}</p>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="bi bi-cash-stack"></i> Datos del Pago</h5>
            </div>
            <div class="card-body">
                <!-- Info del Cliente -->
                <div class="alert alert-info">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-1">
                                <i class="bi bi-person-circle"></i> {{ cliente.nombre_completo }}
                            </h5>
                            <small>
                                {% if cliente.plan %}
                                    Plan: <strong>{{ cliente.plan.nombre }}</strong> - 
                                    ${{ "%.2f"|format(cliente.plan.precio) }}
                                {% else %}
                                    Sin plan asignado
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted d-block">Saldo Pendiente</small>
                            <h4 class="mb-0 {% if cliente.saldo_pendiente > 0 %}text-danger{% else %}text-success{% endif %}">
                                ${{ "%.2f"|format(cliente.saldo_pendiente) }}
                            </h4>
                        </div>
                    </div>
                </div>

                <form method="POST">
                    <!-- Monto -->
                    <div class="mb-3">
                        <label for="monto" class="form-label">Monto a Pagar *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="monto" 
                                   name="monto" 
                                   step="0.01" 
                                   min="0.01"
                                   value="{{ cliente.plan.precio if cliente.plan else '' }}"
                                   required
                                   autofocus>
                        </div>
                        {% if cliente.plan %}
                        <small class="text-muted">
                            Monto sugerido: ${{ "%.2f"|format(cliente.plan.precio) }}
                        </small>
                        {% endif %}
                    </div>

                    <div class="row">
                        <!-- M√©todo de Pago -->
                        <div class="col-md-6 mb-3">
                            <label for="metodo_pago" class="form-label">M√©todo de Pago</label>
                            <select class="form-select" id="metodo_pago" name="metodo_pago">
                                <option value="">Seleccionar...</option>
                                <option value="Efectivo">üíµ Efectivo</option>
                                <option value="Transferencia">üè¶ Transferencia Bancaria</option>
                                <option value="Tarjeta">üí≥ Tarjeta de Cr√©dito/D√©bito</option>
                                <option value="PayPal">üÖøÔ∏è PayPal</option>
                                <option value="Zelle">üí∏ Zelle</option>
                                <option value="Otro">üì± Otro</option>
                            </select>
                        </div>

                        <!-- Periodo -->
                        <div class="col-md-6 mb-3">
                            <label for="periodo" class="form-label">Periodo</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="periodo" 
                                   name="periodo" 
                                   placeholder="Ej: Diciembre 2024">
                            <small class="text-muted">Mes o periodo que cubre este pago</small>
                        </div>
                    </div>

                    <!-- Referencia -->
                    <div class="mb-3">
                        <label for="referencia" class="form-label">Referencia/Comprobante</label>
                        <input type="text" 
                               class="form-control" 
                               id="referencia" 
                               name="referencia" 
                               placeholder="N√∫mero de referencia, comprobante o transacci√≥n">
                        <small class="text-muted">Opcional: n√∫mero de referencia bancaria, ID de transacci√≥n, etc.</small>
                    </div>

                    <!-- Notas -->
                    <div class="mb-3">
                        <label for="notas" class="form-label">Notas</label>
                        <textarea class="form-control" 
                                  id="notas" 
                                  name="notas" 
                                  rows="3"
                                  placeholder="Informaci√≥n adicional sobre este pago..."></textarea>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('cliente_detalle', id=cliente.id) }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Registrar Pago
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Historial Reciente -->
        {% if cliente.pagos %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title"><i class="bi bi-clock-history"></i> √öltimos Pagos de {{ cliente.nombre }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Monto</th>
                                <th>M√©todo</th>
                                <th>Periodo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pago in cliente.pagos[:5] %}
                            <tr>
                                <td>{{ pago.fecha_pago.strftime('%d/%m/%Y') }}</td>
                                <td><span class="badge bg-success">${{ "%.2f"|format(pago.monto) }}</span></td>
                                <td>{{ pago.metodo_pago or '-' }}</td>
                                <td>{{ pago.periodo or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <small class="text-muted">Mostrando los √∫ltimos 5 pagos</small>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Calcular y mostrar sugerencias
    document.getElementById('monto').addEventListener('input', function() {
        const monto = parseFloat(this.value) || 0;
        const saldoPendiente = {{ cliente.saldo_pendiente }};
        
        if (monto > saldoPendiente && saldoPendiente > 0) {
            console.log('El monto excede el saldo pendiente');
        }
    });

    // Auto-generar periodo actual
    document.addEventListener('DOMContentLoaded', function() {
        const periodoInput = document.getElementById('periodo');
        if (!periodoInput.value) {
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const fecha = new Date();
            periodoInput.placeholder = `Ej: ${meses[fecha.getMonth()]} ${fecha.getFullYear()}`;
        }
    });
</script>
{% endblock %}